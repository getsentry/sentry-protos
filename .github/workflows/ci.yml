name: ci

on:
  pull_request:

jobs:
  buf-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          ref: ${{ github.ref }}
      - uses: bufbuild/buf-setup-action@v1.34.0

      - name: buf lint and breaking
        uses: bufbuild/buf-action@v1
        with:
          lint: true
          breaking: true
          format: false
          breaking_against: 'https://github.com/getsentry/sentry-protos.git#branch=main'

  codegen-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Install protoc
        uses: arduino/setup-protoc@v3
 
      - name: Build Rust bindings
        run: |
          make build-rust

      - name: Get a GitHub application token
        id: token
        uses: getsentry/action-github-app-token@main
        with:
          app_id: ${{ vars.SENTRY_INTERNAL_APP_ID }}
          private_key: ${{ secrets.SENTRY_INTERNAL_APP_PRIVATE_KEY }}

      - name: Commit generated Rust code
        uses: getsentry/action-github-commit@v2.0.0
        with:
          message: "chore: Regenerate Rust bindings"
          github-token: ${{ steps.token.outputs.token }}

      - name: Commit generated Rust bindings
        uses: getsentry/action-github-commit@v2.0.0
        with:
          message: "chore: Regenerate Rust bindings"

  codegen-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v2
        with:
          python-version: 3.11

      - name: build python bindings
        run: |
          pip install -r requirements.txt
          make build-py

      - name: run python tests/examples
        run: |
          make test-py
